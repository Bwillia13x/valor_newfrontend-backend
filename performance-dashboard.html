<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valor IVX - Performance Dashboard</title>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/modules.css">
    <style>
        .performance-dashboard {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .status-healthy { background: #10b981; color: white; }
        .status-warning { background: #f59e0b; color: white; }
        .status-critical { background: #ef4444; color: white; }
        .status-degraded { background: #6b7280; color: white; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .metric-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-color);
        }
        
        .metric-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .chart-container {
            background: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .canvas-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .recommendations-section {
            background: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .recommendation-item {
            background: var(--background-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-color);
        }
        
        .recommendation-priority {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .priority-high { background: #ef4444; color: white; }
        .priority-medium { background: #f59e0b; color: white; }
        .priority-low { background: #10b981; color: white; }
        
        .recommendation-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .recommendation-description {
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .recommendation-actions {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .recommendation-actions li {
            padding: 4px 0;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .recommendation-actions li:before {
            content: "â€¢ ";
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .controls-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        .control-button:hover {
            background: var(--accent-hover);
        }
        
        .control-button.secondary {
            background: var(--surface-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .control-button.secondary:hover {
            background: var(--background-color);
        }
        
        .refresh-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alerts-section {
            background: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .alert-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }
        
        .alert-critical { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .alert-warning { border-left-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .alert-info { border-left-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        
        .alert-severity {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .alert-message {
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .alert-details {
            font-size: 14px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="performance-dashboard">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div>
                <h1>Performance Dashboard</h1>
                <p>Real-time system performance monitoring and optimization</p>
            </div>
            <div class="controls-section">
                <button id="startMonitoring" class="control-button">Start Monitoring</button>
                <button id="stopMonitoring" class="control-button secondary">Stop Monitoring</button>
                <button id="refreshData" class="control-button secondary">
                    <span id="refreshIcon" class="refresh-indicator"></span>
                    Refresh
                </button>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">System Status</div>
                    <div id="systemStatus" class="status-indicator status-healthy">Healthy</div>
                </div>
                <div class="metric-value" id="systemStatusValue">Healthy</div>
                <div class="metric-subtitle">Overall system health</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">CPU Usage</div>
                    <div class="metric-value" id="cpuUsage">0%</div>
                </div>
                <div class="metric-subtitle">Current CPU utilization</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Memory Usage</div>
                    <div class="metric-value" id="memoryUsage">0%</div>
                </div>
                <div class="metric-subtitle">Current memory utilization</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Cache Hit Rate</div>
                    <div class="metric-value" id="cacheHitRate">0%</div>
                </div>
                <div class="metric-subtitle">Cache performance</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Database Pool</div>
                    <div class="metric-value" id="dbPoolUtilization">0%</div>
                </div>
                <div class="metric-subtitle">Connection pool utilization</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Active Tasks</div>
                    <div class="metric-value" id="activeTasks">0</div>
                </div>
                <div class="metric-subtitle">Background tasks running</div>
            </div>
        </div>
        
        <!-- Performance Charts -->
        <div class="chart-container">
            <div class="chart-title">System Performance Trends (Last 24 Hours)</div>
            <div class="canvas-container">
                <canvas id="performanceChart" width="800" height="300"></canvas>
            </div>
        </div>
        
        <!-- Performance Alerts -->
        <div class="alerts-section">
            <h3>Performance Alerts</h3>
            <div id="alertsContainer">
                <p>No alerts at this time.</p>
            </div>
        </div>
        
        <!-- Optimization Recommendations -->
        <div class="recommendations-section">
            <h3>Optimization Recommendations</h3>
            <div id="recommendationsContainer">
                <p>Loading recommendations...</p>
            </div>
        </div>
    </div>

    <script>
        class PerformanceDashboard {
            constructor() {
                this.baseUrl = 'http://localhost:5002';
                this.refreshInterval = null;
                this.chart = null;
                this.initializeEventListeners();
                this.loadInitialData();
            }
            
            initializeEventListeners() {
                document.getElementById('startMonitoring').addEventListener('click', () => this.startMonitoring());
                document.getElementById('stopMonitoring').addEventListener('click', () => this.stopMonitoring());
                document.getElementById('refreshData').addEventListener('click', () => this.refreshData());
            }
            
            async loadInitialData() {
                await this.loadSystemStatus();
                await this.loadPerformanceSummary();
                await this.loadRecommendations();
                await this.loadAlerts();
                this.initializeChart();
            }
            
            async startMonitoring() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/performance/start-monitoring`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Tenant-ID': 'demo-tenant'
                        },
                        body: JSON.stringify({ interval: 30 })
                    });
                    
                    if (response.ok) {
                        this.showNotification('Performance monitoring started', 'success');
                        this.startAutoRefresh();
                    } else {
                        this.showNotification('Failed to start monitoring', 'error');
                    }
                } catch (error) {
                    console.error('Error starting monitoring:', error);
                    this.showNotification('Error starting monitoring', 'error');
                }
            }
            
            async stopMonitoring() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/performance/stop-monitoring`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Tenant-ID': 'demo-tenant'
                        }
                    });
                    
                    if (response.ok) {
                        this.showNotification('Performance monitoring stopped', 'success');
                        this.stopAutoRefresh();
                    } else {
                        this.showNotification('Failed to stop monitoring', 'error');
                    }
                } catch (error) {
                    console.error('Error stopping monitoring:', error);
                    this.showNotification('Error stopping monitoring', 'error');
                }
            }
            
            async loadSystemStatus() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/performance/system-status`);
                    if (response.ok) {
                        const data = await response.json();
                        this.updateSystemStatus(data.data);
                    }
                } catch (error) {
                    console.error('Error loading system status:', error);
                }
            }
            
            async loadPerformanceSummary() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/performance/summary`);
                    if (response.ok) {
                        const data = await response.json();
                        this.updatePerformanceMetrics(data.data);
                    }
                } catch (error) {
                    console.error('Error loading performance summary:', error);
                }
            }
            
            async loadRecommendations() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/performance/recommendations`);
                    if (response.ok) {
                        const data = await response.json();
                        this.updateRecommendations(data.data);
                    }
                } catch (error) {
                    console.error('Error loading recommendations:', error);
                }
            }
            
            async loadAlerts() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/performance/alerts`);
                    if (response.ok) {
                        const data = await response.json();
                        this.updateAlerts(data.data);
                    }
                } catch (error) {
                    console.error('Error loading alerts:', error);
                }
            }
            
            updateSystemStatus(data) {
                const statusElement = document.getElementById('systemStatus');
                const statusValueElement = document.getElementById('systemStatusValue');
                
                const status = data.overall_status || 'unknown';
                statusElement.className = `status-indicator status-${status}`;
                statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                statusValueElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                
                // Update component statuses
                if (data.components) {
                    if (data.components.database_system && data.components.database_system[0]) {
                        const dbStatus = data.components.database_system[1];
                        document.getElementById('dbPoolUtilization').textContent = 
                            dbStatus ? 'Healthy' : 'Issues';
                    }
                    
                    if (data.components.task_system && data.components.task_system[0]) {
                        const taskStatus = data.components.task_system[1];
                        document.getElementById('activeTasks').textContent = 
                            taskStatus ? 'Active' : 'Inactive';
                    }
                }
            }
            
            updatePerformanceMetrics(data) {
                if (data.metrics && data.metrics.system) {
                    const system = data.metrics.system;
                    document.getElementById('cpuUsage').textContent = `${system.cpu_percent || 0}%`;
                    document.getElementById('memoryUsage').textContent = `${system.memory_percent || 0}%`;
                }
                
                if (data.metrics && data.metrics.cache) {
                    const cache = data.metrics.cache;
                    if (cache.hits !== undefined && cache.misses !== undefined) {
                        const total = cache.hits + cache.misses;
                        const hitRate = total > 0 ? (cache.hits / total * 100).toFixed(1) : 0;
                        document.getElementById('cacheHitRate').textContent = `${hitRate}%`;
                    }
                }
            }
            
            updateRecommendations(data) {
                const container = document.getElementById('recommendationsContainer');
                
                if (!data.current_issues || data.current_issues.length === 0) {
                    container.innerHTML = '<p>No optimization recommendations at this time.</p>';
                    return;
                }
                
                let html = '';
                data.current_issues.forEach(rec => {
                    html += `
                        <div class="recommendation-item">
                            <div class="recommendation-priority priority-${rec.priority}">${rec.priority}</div>
                            <div class="recommendation-title">${rec.title}</div>
                            <div class="recommendation-description">${rec.description}</div>
                            <ul class="recommendation-actions">
                                ${rec.actions.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            updateAlerts(data) {
                const container = document.getElementById('alertsContainer');
                
                if (!data.alerts || data.alerts.length === 0) {
                    container.innerHTML = '<p>No alerts at this time.</p>';
                    return;
                }
                
                let html = '';
                data.alerts.forEach(alert => {
                    html += `
                        <div class="alert-item alert-${alert.severity}">
                            <div class="alert-severity">${alert.severity}</div>
                            <div class="alert-message">${alert.message}</div>
                            <div class="alert-details">
                                Value: ${alert.value}, Threshold: ${alert.threshold}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            initializeChart() {
                const canvas = document.getElementById('performanceChart');
                const ctx = canvas.getContext('2d');
                
                // Create a simple line chart
                this.chart = {
                    canvas: canvas,
                    ctx: ctx,
                    data: {
                        labels: [],
                        datasets: []
                    }
                };
                
                this.updateChart();
            }
            
            updateChart() {
                // This is a placeholder for chart implementation
                // In a real implementation, you would use Chart.js or similar
                const ctx = this.chart.ctx;
                const canvas = this.chart.canvas;
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw placeholder
                ctx.fillStyle = '#6b7280';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Performance Chart - Data Loading...', canvas.width / 2, canvas.height / 2);
            }
            
            startAutoRefresh() {
                this.refreshInterval = setInterval(() => {
                    this.refreshData();
                }, 30000); // Refresh every 30 seconds
            }
            
            stopAutoRefresh() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
            }
            
            async refreshData() {
                const refreshIcon = document.getElementById('refreshIcon');
                refreshIcon.style.display = 'inline-block';
                
                try {
                    await Promise.all([
                        this.loadSystemStatus(),
                        this.loadPerformanceSummary(),
                        this.loadRecommendations(),
                        this.loadAlerts()
                    ]);
                    
                    this.updateChart();
                    this.showNotification('Data refreshed successfully', 'success');
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    this.showNotification('Error refreshing data', 'error');
                } finally {
                    refreshIcon.style.display = 'none';
                }
            }
            
            showNotification(message, type) {
                // Simple notification system
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 600;
                    z-index: 1000;
                    background: ${type === 'success' ? '#10b981' : '#ef4444'};
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new PerformanceDashboard();
        });
    </script>
</body>
</html>